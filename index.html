<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>FinApp</title>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üí∞</text></svg>"/>
<script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>
<style>
:root{--bg:#f4f6fa;--card:#ffffff;--primary:#3478f6;--green:#34c759;--yellow:#ffcc00;--red:#ff3b30;--text:#1c1c1e;--text-light:#8e8e93;--shadow:0 2px 12px rgba(0,0,0,.08);}
*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;}
body{margin:0;background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100vh;-webkit-user-select:none;}
header{background:var(--card);box-shadow:var(--shadow);padding:14px 20px;display:flex;justify-content:space-between;align-items:center;font-size:17px;font-weight:600;}
#saldo{font-size:20px;color:var(--primary);}
#fecha{color:var(--text-light);font-size:14px;}
main{flex:1;padding:20px 16px 80px;overflow-y:auto;}
.card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:16px;margin-bottom:16px;}
#sem{width:90px;height:90px;border-radius:50%;margin:0 auto 10px;border:4px solid var(--primary);}
.verde{background:var(--green)!important;}.ambar{background:var(--yellow)!important;}.rojo{background:var(--red)!important;}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;}
.prod{display:flex;flex-direction:column;align-items:center;padding:14px;border-radius:12px;background:var(--card);box-shadow:var(--shadow);}
.prod-icon{font-size:32px;margin-bottom:6px;}
.prod-name{font-size:14px;color:var(--text-light);}
.prod-amt{font-size:18px;font-weight:600;color:var(--text);}
.bot-bar{position:fixed;bottom:0;left:0;right:0;background:var(--card);box-shadow:var(--shadow);display:flex;justify-content:space-around;padding:8px 0;}
.bot-bar button{background:none;border:none;font-size:32px;color:var(--text-light);flex:1;padding:8px;}
.bot-bar button:active{color:var(--primary);}
.num{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:8px 0;}
.num button{font-size:24px;padding:18px;border:none;background:#e5e5ea;border-radius:12px;color:var(--text);}
.btn-prim{background:var(--primary)!important;color:#fff!important;}
.btn-sec{background:#e5e5ea!important;color:var(--text)!important;}
.hide{display:none!important;}
#amount{font-size:32px;text-align:center;margin:10px 0;letter-spacing:1px;}
select{width:100%;font-size:16px;padding:10px;border-radius:10px;border:1px solid #c6c6c8;margin-bottom:10px;background:var(--card);}
ul{list-style:none;padding:0;margin:0;}
li{padding:10px;border-bottom:1px solid #e5e5ea;font-size:15px;display:flex;justify-content:space-between;}
li:last-child{border:none;}
.btn-xl{font-size:22px;padding:16px;border-radius:14px;width:100%;margin-bottom:10px;}
</style>
</head>
<body>

<header>
  <div><span id="saldo">$0.00</span><br><span id="fecha"></span></div>
  <div style="font-size:14px;color:var(--text-light)">FinApp</div>
</header>

<main id="vista">
  <div class="card" style="text-align:center"><div id="sem"></div><div id="statusText" style="font-size:18px;font-weight:500">Sin actualizaciones</div></div>
  <div class="card"><div class="grid" id="productos"></div><button class="btn-prim btn-xl" onclick="editarProductos()">+ A√±adir / Editar productos</button></div>
  <div class="card"><div style="font-size:17px;font-weight:600;margin-bottom:8px">Pr√≥ximos 5 d√≠as</div><ul id="proxPagos"></ul><div id="noProx" style="color:var(--text-light);font-size:14px">Nada programado</div></div>
  <div class="grid">
    <button class="btn-prim btn-xl" onclick="quick('gasto')">- Gasto</button>
    <button class="btn-prim btn-xl" onclick="quick('ingreso')">+ Ingreso</button>
    <button class="btn-sec btn-xl" onclick="fotoRecibo()">üì∑ Recibo / Galer√≠a</button>
    <button class="btn-sec btn-xl" onclick="verResumen()">üìã Resumen</button>
  </div>
  <div id="teclado" class="hide card"><div id="amount">$0</div><div class="num">
    <button onclick="n('1')">1</button><button onclick="n('2')">2</button><button onclick="n('3')">3</button>
    <button onclick="n('4')">4</button><button onclick="n('5')">5</button><button onclick="n('6')">6</button>
    <button onclick="n('7')">7</button><button onclick="n('8')">8</button><button onclick="n('9')">9</button>
    <button onclick="n('c')">C</button><button onclick="n('0')">0</button><button onclick="n('.')">.</button>
  </div>
    <select id="cat"></select>
    <select id="medio"><option value="">Medio (opcional)</option><option>Tarjeta-cr√©dito</option><option>D√©bito</option><option>Cripto</option><option>Inversiones</option><option>Terrenos</option></select>
    <div style="display:flex;gap:8px"><button class="btn-prim" style="flex:1" onclick="guardar()">Guardar</button><button class="btn-sec" style="flex:1" onclick="cancelar()">Cancelar</button></div>
  </div>
</main>

<footer class="bot-bar">
  <button onclick="location.reload()">üè†</button><button onclick="verResumen()">üìã</button><button onclick="alert('Pronto m√°s herramientas')">‚öôÔ∏è</button>
</footer>

<script>
const medios = ['Tarjeta-cr√©dito','D√©bito','Cripto','Inversiones','Terrenos'];
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxw-Hm0exfmwqkAzP5HYx7Gbsy1GygceGdnMvXW9l8ZE9zwo0C4C-g-1lyH9CU4RzVwNA/exec'; // tu URL
let modo = '', monto = '0', datos = [], productos = [];

window.onload = async () => {
  document.getElementById('fecha').textContent = new Date().toLocaleDateString('es-MX');
  await cargar();
  actualizarSemaforo();
  pintarProductos();
  proximos5dias();
};

async function cargar(){
  const r = await fetch(SCRIPT_URL + '?action=read');
  datos = await r.json() || [];
  const ing = datos.filter(x=>x.Tipo==='ingreso').reduce((a,x)=>a+parseFloat(x.Monto||0),0);
  const gas = datos.filter(x=>x.Tipo==='gasto').reduce((a,x)=>a+parseFloat(x.Monto||0),0);
  document.getElementById('saldo').textContent = '$' + (ing-gas).toFixed(2);
}

function actualizarSemaforo(){
  const ing = datos.filter(x=>x.Tipo==='ingreso' && esteMes(x.Fecha)).reduce((a,x)=>a+parseFloat(x.Monto||0),0);
  const gas = datos.filter(x=>x.Tipo==='gasto'   && esteMes(x.Fecha)).reduce((a,x)=>a+parseFloat(x.Monto||0),0);
  const el = document.getElementById('sem'); el.className = '';
  let txt = 'Sin actualizaciones';
  if(datos.length){
    if (gas < ing*0.8)      { el.classList.add('verde'); txt = 'Saludable'; }
    else if (gas < ing*0.95){ el.classList.add('ambar'); txt = 'Cuidado';   }
    else                    { el.classList.add('rojo');  txt = 'Cr√≠tico';   }
  }
  document.getElementById('statusText').textContent = txt;
}
function esteMes(f){const d=new Date(f);const hoy=new Date();return d.getMonth()===hoy.getMonth()&&d.getFullYear()===hoy.getFullYear();}

function pintarProductos(){
  const div=document.getElementById('productos');
  div.innerHTML='';
  medios.forEach(m=>{
    const ing=datos.filter(x=>x.Tipo==='ingreso'&&(x.CtaOrigen===m||x.CtaDestino===m)).reduce((a,x)=>a+parseFloat(x.Monto||0),0);
    const gas=datos.filter(x=>x.Tipo==='gasto'  &&(x.CtaOrigen===m||x.CtaDestino===m)).reduce((a,x)=>a+parseFloat(x.Monto||0),0);
    const saldo=ing-gas;
    const icons={'Tarjeta-cr√©dito':'üí≥','D√©bito':'üí∞','Cripto':'‚Çø','Inversiones':'üìà','Terrenos':'üè°'};
    div.innerHTML+=`<div class="prod"><div class="prod-icon">${icons[m]||'üìä'}</div><div class="prod-name">${m}</div><div class="prod-amt">$${saldo.toFixed(2)}</div></div>`;
  });
}
/* ---------- EDITOR COMPLETO DE PRODUCTOS ---------- */
let productosCache = []; // local r√°pido

function editarProductos(){
  // leemos productos actuales
  productosCache = datos.filter(x=>x.Tipo==='producto');
  mostrarListaProductos();
}

function mostrarListaProductos(){
  let html=`<div class="card"><h2>Mis productos</h2>`;
  if(!productosCache.length){html+=`<p style="color:var(--text-light)">Sin productos</p>`;}
  else{
    html+=`<ul>`;
    productosCache.forEach((p,idx)=>{
      html+=`<li style="display:flex;justify-content:space-between;align-items:center">
               <span><strong>${p.Cat}</strong> (${p.Subcat}) ‚Äì $${p.Monto}</span>
               <span>
                 <button onclick="editarProductoForm(${idx})" style="margin-right:8px">‚úèÔ∏è</button>
                 <button onclick="borrarProducto(${idx})">üóëÔ∏è</button>
               </span>
             </li>`;
    });html+=`</ul>`;
  }
  html+=`<button class="btn-prim btn-xl" onclick="nuevoProductoForm()">+ A√±adir producto</button>
         <button class="btn-sec btn-xl" onclick="cierraProductos()">Cerrar</button></div>`;
  document.getElementById('vista').innerHTML=html;
}

function nuevoProductoForm(){
  mostrarFormProducto(-1); // -1 = nuevo
}

function editarProductoForm(idx){
  mostrarFormProducto(idx); // idx >= 0 = edici√≥n
}

function mostrarFormProducto(idx){
  const p = idx>=0 ? productosCache[idx] : null;
  let html=`<div class="card">
              <h2>${idx>=0 ? 'Editar' : 'A√±adir'} producto</h2>
              <input id="prodNombre" type="text" placeholder="Nombre del producto" value="${p ? p.Cat : ''}" style="width:100%;padding:10px;margin-bottom:10px;border-radius:10px;border:1px solid #c6c6c8;">
              <select id="prodTipo" style="width:100%;padding:10px;margin-bottom:10px;border-radius:10px;border:1px solid #c6c6c8;">
                <option value="Tarjeta-cr√©dito" ${p && p.Subcat==='Tarjeta-cr√©dito' ? 'selected' : ''}>üí≥ Tarjeta-cr√©dito</option>
                <option value="D√©bito" ${p && p.Subcat==='D√©bito' ? 'selected' : ''}>üè¶ D√©bito</option>
                <option value="Cripto" ${p && p.Subcat==='Cripto' ? 'selected' : ''}>‚Çø Cripto</option>
                <option value="Inversiones" ${p && p.Subcat==='Inversiones' ? 'selected' : ''}>üìà Inversiones</option>
                <option value="Terrenos" ${p && p.Subcat==='Terrenos' ? 'selected' : ''}>üè° Terrenos</option>
              </select>
              <input id="prodSaldo" type="number" step="0.01" placeholder="Saldo inicial" value="${p ? p.Monto : ''}" style="width:100%;padding:10px;margin-bottom:10px;border-radius:10px;border:1px solid #c6c6c8;">
              <div style="display:flex;gap:8px">
                <button class="btn-prim" style="flex:1" onclick="guardarProducto(${idx})">Guardar</button>
                <button class="btn-sec" style="flex:1" onclick="mostrarListaProductos()">Cancelar</button>
              </div>
            </div>`;
  document.getElementById('vista').innerHTML=html;
}

async function guardarProducto(idx){
  const nombre=document.getElementById('prodNombre').value.trim();
  const tipo=document.getElementById('prodTipo').value;
  const saldo=parseFloat(document.getElementById('prodSaldo').value)||0;
  if(!nombre){alert('Escribe un nombre');return;}
  // Si es edici√≥n, primero borramos el anterior
  if(idx>=0){
    const viejo=productosCache[idx];
    await borrarProductoBackend(viejo);
  }
  // Guardamos el nuevo/actualizado
  const fila={
    Fecha:new Date().toISOString(),
    Tipo:'producto',
    Cat:nombre,
    Subcat:tipo,
    Monto:saldo,
    Divisa:'MXN',
    CtaOrigen:tipo,
    CtaDestino:'',
    Nota:'Producto desde app',
    UUID:self.crypto.randomUUID()
  };
  await fetch(SCRIPT_URL,{method:'POST',body:new URLSearchParams({action:'write',row:JSON.stringify(fila)})});
  alert('Producto guardado');
  // recargar datos y volver
  await cargar();pintarProductos();proximos5dias();
  cierraProductos();
}

async function borrarProducto(idx){
  if(!confirm('¬øBorrar este producto?'))return;
  const p=productosCache[idx];
  await borrarProductoBackend(p);
  alert('Producto borrado');
  await cargar();pintarProductos();proximos5dias();
  mostrarListaProductos();
}

async function borrarProductoBackend(p){
  // Marcamos como borrado (o puedes hacer l√≥gica real de eliminar fila)
  const filaBorrar={
    ...p,
    Tipo:'producto-borrado',
    Nota:'Borrado desde app'
  };
  await fetch(SCRIPT_URL,{method:'POST',body:new URLSearchParams({action:'write',row:JSON.stringify(filaBorrar)})});
}

function cierraProductos(){
  window.location.reload(); // vuelve a inicio
}
  
function proximos5dias(){
  const hoy=new Date();const max=new Date(hoy);max.setDate(hoy.getDate()+5);
  const prox=datos.filter(x=>{const fx=new Date(x.Fecha);return fx>=hoy&&fx<=max&&(x.Tipo==='suscripci√≥n'||x.Tipo==='tarjeta-corte'||x.Tipo==='tarjeta-pago');}).sort((a,b)=>new Date(a.Fecha)-new Date(b.Fecha));
  const ul=document.getElementById('proxPagos');const no=document.getElementById('noProx');
  if(prox.length){no.style.display='none';ul.innerHTML=prox.map(x=>`<li>${x.Fecha.slice(0,10)} ‚Äì ${x.Cat} ($${x.Monto})</li>`).join('');}else{no.style.display='block';ul.innerHTML='';}
}

function fotoRecibo(){
  const inp=document.createElement('input');inp.type='file';inp.accept='image/*';
  inp.onchange=async e=>{const file=e.target.files[0];if(!file)return;const txt=await OCR(file);const nums=txt.match(/\d+\.\d{2}|\d+/g);if(nums&&nums.length){monto=nums.pop();quick('gasto');document.getElementById('amount').textContent='$'+monto;}else{alert('No encontr√© monto claro');}};inp.click();
}
async function OCR(file){const{createWorker}=Tesseract;const worker=await createWorker('spa');const ret=await worker.recognize(file);await worker.terminate();return ret.data.text;}

function quick(t){
  modo=t;monto='0';document.getElementById('amount').textContent='$0';const sel=document.getElementById('cat');sel.innerHTML='';
  const cats=t==='gasto'?['üçî Alimentos','üöó Transporte','üè† Casa','üéâ Salidas','üíä Salud','üì± Tecnolog√≠a','üõçÔ∏è Otros']:['üí∞ N√≥mina','üéÅ Regalo','üìà Intereses','‚Ü©Ô∏è Devoluci√≥n','üíº Otros'];
  cats.forEach(c=>sel.add(new Option(c,c)));document.getElementById('teclado').classList.remove('hide');
}
function cancelar(){document.getElementById('teclado').classList.add('hide');}
function n(v){if(v==='c'){monto='0';}else{monto=monto==='0'?v:monto+v;}document.getElementById('amount').textContent='$'+monto;}
async function guardar(){
  const fila={Fecha:new Date().toISOString(),Tipo:modo==='gasto'?'gasto':'ingreso',Cat:document.getElementById('cat').value,Subcat:'',Monto:parseFloat(monto).toFixed(2),Divisa:'MXN',CtaOrigen:document.getElementById('medio').value||'D√©bito',CtaDestino:'',Nota:'',UUID:self.crypto.randomUUID()};
  await fetch(SCRIPT_URL,{method:'POST',body:new URLSearchParams({action:'write',row:JSON.stringify(fila)})});
  cancelar();await cargar();actualizarSemaforo();pintarProductos();proximos5dias();
}
function verResumen(){
  let html=`<h2>Resumen de movimientos</h2><select id="filtroMedio" onchange="filtraResumen()"><option value="">Todos los medios</option>`;
  medios.forEach(m=>html+=`<option value="${m}">${m}</option>`);html+=`</select><ul id="listaMov">Cargando‚Ä¶</ul><button class="btn-sec btn-xl" onclick="cierraResumen()">Cerrar</button>`;
  document.getElementById('vista').innerHTML=html;filtraResumen();
}
function filtraResumen(){const medio=document.getElementById('filtroMedio').value;let fil=datos;if(medio)fil=datos.filter(x=>(x.CtaOrigen===medio||x.CtaDestino===medio));const lista=document.getElementById('listaMov');lista.innerHTML=fil.map(x=>`<li>${x.Fecha.slice(0,10)} ‚Äì ${x.Cat} ‚Äì $${x.Monto} (${x.Tipo})</li>`).join('');}
function cierraResumen(){window.location.reload();}
</script>
</body>
</html>
